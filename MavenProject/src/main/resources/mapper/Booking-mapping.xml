<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="BookingMapper">
		<resultMap id="bookingRM" type="booking">
	    <id property="bNum" column="b_Num" />
	    <result property="bDate" column="b_date" />
	    <result property="bTime" column="b_time" />
	    <result property="bStatus" column="b_status" />
	
	    <association property="hospital" javaType="Hospital">
	        <id property="hNum" column="h_num" />
	        <result property="hDepartment" column="h_department" />
	        <result property="hTitle" column="h_title" />
	        <result property="hDistrict" column="h_district" />
	        <result property="hAddress" column="h_address" />
	        <result property="hTel" column="h_tel" />
	        <result property="hUrl" column="h_url" />
	    </association>
	
	    <association property="member" javaType="Member">
	        <id property="mNum" column="m_num" />
	        <result property="mId" column="m_id" />
	        <result property="mName" column="m_name" />
	        <result property="mPhone" column="m_phone" />
	        <result property="mAge" column="m_age" />
	    </association>
	</resultMap>
	
	<!-- 예약 등록 -->
	<!-- B_DATE는 CURDATE(), B_STATUS는 DEFALUT 0 (FALSE) -->
	<insert id="insertBooking" parameterType="booking" useGeneratedKeys="true"  keyProperty="bNum">
		INSERT INTO BOOKING(M_NUM,H_NUM,B_DATE,B_TIME)
		VALUES(#{member.mNum},#{hospital.hNum},CURDATE(),#{bTime})
	</insert>
	
	<!-- 예약 삭제 -->
	<delete id="deleteBooking" parameterType="int">
		DELETE FROM BOOKING WHERE B_NUM=#{VALUE}
	</delete>
	
	<!-- 예약 수정  -->
	<update id="updateBookingStatus" parameterType="map">
		UPDATE BOOKING SET B_STATUS = #{Status} WHERE B_NUM = #{bNum}
	</update>
	<!-- 회원별 예약조회 -->
	<select id="searchBookingByMember" parameterType="int" resultMap="bookingRM">
		SELECT B.B_NUM, H.H_NUM, H.H_DEPARTMENT, H.H_DISTRICT, B.B_DATE, B.B_TIME, M.M_NUM, H.H_URL, H.H_TITLE, B.B_Status
		FROM BOOKING B
		JOIN MEMBER M ON B.M_NUM = M.M_NUM
		JOIN HOSPITAL H ON B.H_NUM = H.H_NUM
		WHERE B.M_NUM = #{VALUE}
	</select>
	
	<!--연령별 예약횟수 조회  -->
	<select id="countBookingByAge" resultType="map">
	    SELECT M.M_AGE, COUNT(*) AS count
	    FROM BOOKING B
	    JOIN MEMBER M ON B.M_NUM = M.M_NUM
	    GROUP BY M.M_AGE
	</select>
	
	<!-- 진료과목 별 예약 연령 조회 -->
	<select id="countBookingByDeptAge" resultType="map">
	    SELECT H.H_DEPARTMENT, M.M_AGE, COUNT(*) AS count
	    FROM BOOKING B
	    JOIN MEMBER M ON B.M_NUM = M.M_NUM
	    JOIN HOSPITAL H ON B.H_NUM = H.H_NUM
	    GROUP BY H.H_DEPARTMENT , M.M_AGE
	</select>
	
	<!-- 지역구 별 예약 진료과목 조회 -->
	<select id="countBookingByDistrictDept" resultType="map">
	    SELECT H.H_DISTRICT, H.H_DEPARTMENT, COUNT(*) AS count
	    FROM BOOKING B
	    JOIN HOSPITAL H ON B.H_NUM = H.H_NUM
	    GROUP BY H.H_DISTRICT , H.H_DEPARTMENT
	</select>
</mapper>

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 